<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>木桶布局</title>
  <style>
    .ct{
      width: 960px;
      margin: 0 auto;
      /*border: 1px solid #000;*/
    }
    .img-row{
      margin-bottom: 10px;
    }
    .img-row:after{
      content: '';
      display: block;
      clear: both;
    }
    .img-row>div.img{
      float: left;
      height: 200px;
      /*margin-left: 5px;*/
    }
/*    div.img:first-child{
      margin-left: 0;
    }*/
  </style>
</head>
<body>
  <div class="ct">
  </div>
  <script src="http://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
  <script>
  //获取url
  //生成
  //遍历图片，将每张图片放在某行计算是否超出
  //放置图片
    function Barrel(){
      this.imgRowWidth = 0
      this.imgList = []
      this.$ct = $('.ct')
      this.loadImg()
    }

    Barrel.prototype = {
      getImage:function(num){
        var width,height,color,urls = []
        for(var i= 0;i< num;i++){
          height = parseInt(Math.random()*100+50)
          width = parseInt(Math.random()*100+50)
          color = Math.random().toString(16).substring(2,8)
          urls.push('http://fakeimg.pl/'+width+'x'+height+'/'+color+',128/000,255')
        }
        return urls
      },

      loadImg:function(){
        var _this = this
        var imgurls = this.getImage(20)
        var ctWidth = $('.ct').width()
        var count = 0
        xx()
        function xx(){
          $.each(imgurls,function(index, el) {
            var img = new Image()
            img.src = el
            img.onload = function(){  //onload不是jquery方法
              count++
              _this.imgList.push(img)
              img.width = 100*img.width/img.height
              img.height = 100
              _this.imgRowWidth += img.width

              if(_this.imgRowWidth > ctWidth){
                _this.imgList.pop()
                ratio = ctWidth/(_this.imgRowWidth-img.width)

                if($('.ct').height() < $(window).height()){
                  _this.layout()
                  _this.imgList = []
                  _this.imgRowWidth = 0
                  imgurls = imgurls.slice(count-1)
                  imgurls = imgurls.concat(_this.getImage(20))
                  count = 0
                  xx()
                }
              }
            }
          })
        }
      },

      layout:function(){
        var _this = this
        this.$ct.append('<div class="img-row"></div>')
        var $imgRow = $('.img-row').last()
        $.each(this.imgList,function(index,el){  //每个el是不是只能append一次
          el.height *= ratio
          el.width *= ratio
          $imgRow.append(el)
        })
      }
    }

    new Barrel()
  </script>
</body>
</html>